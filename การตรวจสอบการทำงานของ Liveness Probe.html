<!doctype html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>การตรวจสอบการทำงานของ Liveness Probe</title>
    <style>
        /* --- ตัวแปรกลางสำหรับ Theme --- */
        :root {
            --bg-color: #f9fafb;
            --text-color: #374151;
            --primary-color: #2563eb;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --code-bg: #111827;
            --code-text-color: #e5e7eb;
            --heading-color: #1f2937;
            --success-color: #16a34a;
            --danger-color: #dc2626;
            --info-bg: #eff6ff;
            --info-border: #93c5fd;
            --font-family: 'Sarabun', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-mono: 'Fira Code', 'JetBrains Mono', monospace;
        }

        /* --- Reset และค่าเริ่มต้น --- */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            line-height: 1.8;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            padding: 2rem;
        }

        /* --- โครงสร้างหลัก --- */
        .container {
            width: 100%;
            max-width: 1024px;
            background-color: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.07), 0 4px 6px -2px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        header {
            padding: 2rem 2.5rem;
            background: linear-gradient(to right, #f3f4f6, #e5e7eb);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        header svg {
            flex-shrink: 0;
            color: var(--primary-color);
        }

        main {
            padding: 2.5rem;
        }
        
        section {
            margin-bottom: 3.5rem;
        }
        
        section:last-child {
            margin-bottom: 0;
        }

        /* --- องค์ประกอบตัวอักษร --- */
        h1 {
            margin: 0;
            font-size: 2.1rem;
            font-weight: 700;
            color: var(--heading-color);
        }

        h2 {
            font-size: 1.7rem;
            color: var(--heading-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.75rem;
            margin-top: 0;
            margin-bottom: 1.5rem;
        }
        
        p, li {
            font-size: 1.05rem;
        }

        code.inline-code {
            font-family: var(--font-mono);
            background-color: #eef2ff;
            color: var(--primary-color);
            padding: 0.2em 0.5em;
            border-radius: 6px;
            font-size: 0.9em;
        }
        
        /* --- ส่วนประกอบ UI --- */
        .info-box {
            background-color: var(--info-bg);
            border-left: 4px solid var(--info-border);
            padding: 1.25rem 1.75rem;
            border-radius: 8px;
            margin: 2rem 0;
        }
        
        .info-box strong {
            color: var(--primary-color);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .summary-card {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .summary-card h3 {
            margin-top: 0;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--heading-color);
        }
        
        .summary-card .status-running { color: var(--success-color); }
        .summary-card .status-terminated { color: var(--danger-color); }

        /* --- ส่วน Code Block --- */
        .code-block-wrapper {
            background-color: var(--code-bg);
            border-radius: 12px;
            margin-top: 1.5rem;
            overflow: hidden;
            position: relative;
        }
        
        .code-block-wrapper pre {
            margin: 0;
            padding: 1.5rem;
            color: var(--code-text-color);
            font-family: var(--font-mono);
            font-size: 0.9rem;
            line-height: 1.7;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        
        .code-block-wrapper .copy-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: #374151;
            color: white;
            border: none;
            padding: 0.5rem 0.8rem;
            border-radius: 6px;
            font-family: var(--font-family);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .code-block-wrapper .copy-button:hover {
            background-color: #4b5563;
        }

        .code-block-wrapper .copy-button.copied {
            background-color: var(--success-color);
            transform: scale(1.05);
        }
        
        /* --- Canvas --- */
        canvas {
            display: block;
            width: 100%;
            margin: 2rem auto 0;
            border-radius: 12px;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
        }
        
        /* --- Responsive --- */
        @media (max-width: 768px) {
            body { padding: 1rem; }
            main, header { padding: 1.5rem; }
            h1 { font-size: 1.8rem; }
            h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w.org/2000/svg" aria-hidden="true">
                <path d="M11 19.5C15.6944 19.5 19.5 15.6944 19.5 11C19.5 6.30558 15.6944 2.5 11 2.5C6.30558 2.5 2.5 6.30558 2.5 11C2.5 15.6944 6.30558 19.5 11 19.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M17.5 17.5L21.5 21.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div>
                 <h1>การตรวจสอบการทำงานของ Liveness Probe</h1>
            </div>
        </header>

        <main>
            <section id="summary-from-images">
                <h2>สรุปผลลัพธ์จาก `kubectl describe`</h2>
                <p>
                    คำสั่ง <code class="inline-code">kubectl describe pod</code> จะแสดงข้อมูลสำคัญที่ช่วยให้เราเข้าใจสถานะของ Container ได้อย่างละเอียด ซึ่งแบ่งได้เป็น 2 ส่วนหลักๆ คือสถานะปัจจุบัน และข้อมูลย้อนหลังของ Container ที่ถูกรีสตาร์ทไป
                </p>
                <div class="summary-grid">
                    <article class="summary-card">
                        <h3 class="status-running">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w.org/2000/svg" aria-hidden="true"><path d="M22 11.08V12C21.9988 14.1564 21.3005 16.2547 20.0093 17.9818C18.7182 19.709 16.9033 20.9725 14.8354 21.5839C12.7674 22.1953 10.5573 22.1219 8.53447 21.3746C6.51168 20.6273 4.78465 19.2461 3.61096 17.4371C2.43727 15.628 1.87979 13.4881 2.02168 11.3363C2.16356 9.18455 2.99721 7.13631 4.39828 5.49706C5.79935 3.85781 7.69279 2.71537 9.79619 2.24013C11.8996 1.7649 14.1003 2.00075 16.07 2.91001" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 4L12 14.01L9 11.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            Container ตัวใหม่ (ปัจจุบัน)
                        </h3>
                        <ul>
                            <li><strong>State:</strong> <code>Running</code> - สถานะปัจจุบันคือทำงานปกติ</li>
                        </ul>
                    </article>
                     <article class="summary-card">
                        <h3 class="status-terminated">
                             <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w.org/2000/svg" aria-hidden="true"><path d="M10.29 3.86L1.82 18C1.62919 18.3545 1.61336 18.7613 1.78533 19.1062C1.9573 19.4511 2.29983 19.6953 2.69 19.71H21.31C21.7002 19.6953 22.0427 19.4511 22.2147 19.1062C22.3866 18.7613 22.3708 18.3545 22.18 18L13.71 3.86C13.5209 3.51151 13.1935 3.28424 12.8245 3.25141C12.4555 3.21859 12.0947 3.38527 11.87 3.69L11.84 3.73L10.29 3.86Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 9V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 17H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            Container ตัวเก่า (ย้อนหลัง)
                        </h3>
                         <ul>
                            <li><strong>Last State:</strong> <code>Terminated</code> - ถูกปิดไปด้วยเหตุผล <code>Error</code></li>
                             <li><strong>Exit Code:</strong> <code>137</code> - ถูก kill ด้วย signal ภายนอก (SIGKILL)</li>
                             <li><strong>Restart Count:</strong> <code>1</code> - มีการรีสตาร์ทไปแล้ว 1 ครั้ง</li>
                             <li><strong>Events:</strong> แสดงเหตุการณ์ว่า Container ถูก kill เพราะ <code class="inline-code">unhealthy</code></li>
                        </ul>
                    </article>
                </div>
            </section>
            
            <section id="how-to-check">
                <h2>วิธีการตรวจสอบ</h2>
                 <ol>
                    <li><strong>ดูจำนวนการรีสตาร์ท:</strong> ใช้คำสั่ง <code class="inline-code">kubectl get po</code> เพื่อดูจำนวนครั้งที่ Container ถูกรีสตาร์ทในคอลัมน์ <code>RESTARTS</code></li>
                    <li><strong>ดู Log ของ Container ตัวเก่า:</strong> หากต้องการหาสาเหตุว่าทำไม Container ตัวก่อนหน้าถึง crash สามารถดู log ของมันได้โดยใช้ flag <code class="inline-code">--previous</code></li>
                    <li><strong>ดูรายละเอียดเชิงลึก:</strong> คำสั่ง <code class="inline-code">kubectl describe</code> จะให้ข้อมูลที่ละเอียดที่สุด ทั้ง <code class="inline-code">Exit Code</code> และ <code class="inline-code">Events</code> ที่เกิดขึ้น</li>
                </ol>
                <div class="info-box">
                    <strong>สิ่งสำคัญที่ต้องรู้:</strong> การ "รีสตาร์ท" container ใน Kubernetes ไม่ใช่การเปิด container ตัวเดิมขึ้นมาใหม่ แต่เป็นการ <strong>สร้าง container ใหม่ทั้งหมด</strong> ขึ้นมาทดแทนตัวเก่า
                </div>
            </section>

             <section id="diagram">
                <h2>ภาพรวมกระบวนการรีสตาร์ท</h2>
                <canvas id="restartProcessCanvas" width="800" height="200" aria-label="ไดอะแกรมแสดงกระบวนการที่ Kubelet ตรวจพบ Container ที่ unhealthy แล้วสร้าง Container ใหม่ขึ้นมาทดแทน"></canvas>
            </section>

            <section id="code-example">
                <h2>ตัวอย่างคำสั่ง</h2>
                <div class="code-block-wrapper">
                    <button class="copy-button" aria-label="คัดลอกโค้ด">คัดลอก</button>
                    <pre><code id="bashCode"># ตรวจสอบสถานะและจำนวนการรีสตาร์ทของ pod
# สังเกตที่คอลัมน์ RESTARTS จะเห็นว่ามีจำนวนเพิ่มขึ้น
$ kubectl get po kubia-liveness

# แสดง log ของ container "ตัวปัจจุบัน" ที่กำลังรันอยู่
$ kubectl logs kubia-liveness

# แสดง log ของ container "ตัวก่อนหน้า" ที่ถูกรีสตาร์ทไปแล้ว
# ใช้ flag --previous เพื่อดู log ของตัวที่ crash ไป
$ kubectl logs kubia-liveness --previous

# แสดงรายละเอียดทั้งหมดของ pod รวมถึงสถานะ, restart count และ events
$ kubectl describe po kubia-liveness

# --- ตัวอย่างผลลัพธ์จาก 'kubectl describe' ---
# Last State:      Terminated
#   Reason:        Error
#   Exit Code:     137
# ...
# Restart Count:   1
# ...
# Events:
#  ... Killing container ...: container "kubia" is unhealthy, it will be killed and re-created
</code></pre>
                </div>
            </section>
        </main>
    </div>

    <script>
        /**
         * ฟังก์ชัน Utility สำหรับจัดการ UI และการวาด Canvas
         * ถูกเขียนเป็นฟังก์ชันย่อยๆ เพื่อให้โค้ดสะอาดและนำกลับมาใช้ใหม่ได้
         */

        /**
         * จัดการการคัดลอกข้อความจาก Code Block
         * @param {string} codeElementId - ID ของ element ที่มี code
         * @param {HTMLButtonElement} buttonElement - Element ของปุ่มที่กด
         */
        const handleCodeCopy = (codeElementId, buttonElement) => {
            const codeEl = document.getElementById(codeElementId);
            if (!codeEl || !buttonElement) return;

            const textArea = document.createElement('textarea');
            textArea.value = codeEl.textContent;
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                buttonElement.textContent = 'คัดลอกแล้ว!';
                buttonElement.classList.add('copied');
                
                setTimeout(() => {
                    buttonElement.textContent = 'คัดลอก';
                    buttonElement.classList.remove('copied');
                }, 2000);
            } catch (err) {
                console.error('ไม่สามารถคัดลอกโค้ดได้:', err);
                buttonElement.textContent = 'ล้มเหลว';
            }
            
            document.body.removeChild(textArea);
        };

        // --- ฟังก์ชันสำหรับวาด Canvas ---
        
        // ค่าคงที่สำหรับสีและฟอนต์
        const GFX = {
            COLORS: {
                PRIMARY: '#2563eb', SUCCESS: '#16a34a', DANGER: '#dc2626',
                TEXT: '#374151', BORDER: '#e5e7eb',
            },
            FONTS: {
                NORMAL: '13px var(--font-family)', BOLD: 'bold 14px var(--font-family)'
            }
        };

        /**
         * วาดกล่องข้อความบน Canvas
         */
        const drawTextBlock = (ctx, pos, text, style, subtext = '') => {
            const { x, y, w, h } = pos;
            ctx.fillStyle = style.fill;
            ctx.strokeStyle = style.stroke;
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.roundRect(x, y, w, h, 8);
            ctx.fill();
            ctx.stroke();

            ctx.fillStyle = GFX.COLORS.TEXT;
            ctx.font = GFX.FONTS.BOLD;
            ctx.textAlign = 'center';
            const textY = subtext ? y + h / 2 - 8 : y + h / 2;
            ctx.fillText(text, x + w / 2, textY);
            
            if (subtext) {
                ctx.font = GFX.FONTS.NORMAL;
                ctx.fillStyle = style.subtextColor || GFX.COLORS.TEXT;
                ctx.fillText(subtext, x + w / 2, y + h / 2 + 10);
            }
        };
        
        /**
         * วาดลูกศรเชื่อมระหว่างจุด
         */
        const drawArrow = (ctx, from, to, label) => {
            const headlen = 10;
            const angle = Math.atan2(to.y - from.y, to.x - from.x);
            ctx.strokeStyle = GFX.COLORS.TEXT;
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.moveTo(from.x, from.y);
            ctx.lineTo(to.x, to.y);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(to.x, to.y);
            ctx.lineTo(to.x - headlen * Math.cos(angle - Math.PI / 6), to.y - headlen * Math.sin(angle - Math.PI / 6));
            ctx.lineTo(to.x - headlen * Math.cos(angle + Math.PI / 6), to.y - headlen * Math.sin(angle + Math.PI / 6));
            ctx.closePath();
            ctx.fillStyle = GFX.COLORS.TEXT;
            ctx.fill();

            ctx.font = GFX.FONTS.NORMAL;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            ctx.fillText(label, from.x + (to.x - from.x) / 2, from.y + (to.y - from.y) / 2 - 8);
        };

        /**
         * (Renderer) วาดไดอะแกรมกระบวนการรีสตาร์ท
         */
        const renderRestartProcess = (canvasEl) => {
            if (!canvasEl?.getContext) return;
            const ctx = canvasEl.getContext('2d');
            const { width, height } = canvasEl;
            const centerY = height / 2;

            // ตำแหน่งขององค์ประกอบ
            const P = {
                oldContainer: { x: 50, y: centerY - 40, w: 150, h: 80 },
                kubelet: { x: 325, y: centerY - 30, w: 150, h: 60 },
                newContainer: { x: 600, y: centerY - 40, w: 150, h: 80 },
            };

            // วาดกล่อง
            drawTextBlock(ctx, P.oldContainer, 'Container A', { fill: '#fee2e2', stroke: GFX.COLORS.DANGER, subtextColor: GFX.COLORS.DANGER }, 'Terminated (unhealthy)');
            drawTextBlock(ctx, P.kubelet, 'Kubelet', { fill: '#eef2ff', stroke: GFX.COLORS.PRIMARY });
            drawTextBlock(ctx, P.newContainer, 'Container B', { fill: '#dcfce7', stroke: GFX.COLORS.SUCCESS, subtextColor: GFX.COLORS.SUCCESS }, 'Running (New)');

            // วาดลูกศร
            drawArrow(ctx, { x: P.oldContainer.x + P.oldContainer.w, y: centerY }, { x: P.kubelet.x, y: centerY }, 'Liveness probe fails');
            drawArrow(ctx, { x: P.kubelet.x + P.kubelet.w, y: centerY }, { x: P.newContainer.x, y: centerY }, 'Creates new container');
        };
        
        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            const copyButton = document.querySelector('.copy-button');
            copyButton.addEventListener('click', () => handleCodeCopy('bashCode', copyButton));

            const canvas = document.getElementById('restartProcessCanvas');
            renderRestartProcess(canvas);
        });
    </script>
</body>
</html>